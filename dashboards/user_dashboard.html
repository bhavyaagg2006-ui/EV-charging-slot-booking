<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>EV User Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: {
              50: '#effef6',
              100: '#d9fde9',
              200: '#b5f9d4',
              300: '#84f2b8',
              400: '#4ae79a',
              500: '#22c55e',
              600: '#16a34a',
              700: '#15803d',
              800: '#166534',
              900: '#14532d'
            },
            surface: '#0b1220',
            panel: '#0f172a'
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.19.0/tabler-icons.min.css" />
  <style>
    body {
      background: radial-gradient(1200px 800px at 10% -10%, rgba(34, 197, 94, .12), transparent 60%),
        radial-gradient(1000px 700px at 110% 10%, rgba(56, 189, 248, .12), transparent 60%),
        #0b1220;
    }

    .glass {
      background: rgba(15, 23, 42, .7);
      border: 1px solid rgba(148, 163, 184, .15);
      backdrop-filter: blur(8px)
    }
  </style>
</head>

<body class="text-slate-100 font-sans min-h-screen flex flex-col">

  <!-- Topbar -->
  <header class="sticky top-0 z-40 backdrop-blur bg-surface/70 border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span
          class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-brand-500 text-slate-900 font-extrabold">EV</span>
        <div>
          <div class="text-sm text-slate-400">Welcome back</div>
          <div id="userName" class="text-base font-semibold">Loading…</div>
        </div>
      </div>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#" class="hover:text-brand-300">Dashboard</a>
        <a href="#" class="hover:text-brand-300">Bookings</a>
        <a href="#" class="hover:text-brand-300">Support</a>
      </nav>

      <div class="flex items-center gap-3">
        <span id="userRoleBadge" class="px-3 py-1 rounded-lg text-xs border border-slate-700 text-slate-300">Role:
          …</span>
        <button id="logoutBtn"
          class="px-4 py-2 rounded-xl bg-brand-500 text-slate-900 font-semibold hover:bg-brand-400 transition inline-flex items-center gap-2">
          <i class="ti ti-logout"></i> Logout
        </button>
      </div>
    </div>
  </header>

  <!-- Hero / Banner -->
  <section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-8">
    <div class="glass rounded-3xl overflow-hidden">
      <div class="grid lg:grid-cols-2">
        <div class="p-8 sm:p-10">
          <h1 class="text-3xl sm:text-4xl font-extrabold leading-tight">
            Charge smarter. Go further. ⚡
          </h1>
          <p class="mt-3 text-slate-300">
            Find nearby charging bunks, view live slot vacancy, and reserve your window before you arrive.
          </p>
          <div class="mt-6 flex flex-wrap gap-3">
            <a href="/pages/search-bunk.html"
              class="px-5 py-3 rounded-xl bg-brand-500 text-slate-900 font-semibold hover:bg-brand-400 transition inline-flex items-center gap-2">
              <i class="ti ti-map-2"></i> Search Nearby Bunks
            </a>
            <a href="/pages/slot-vacancy.html"
              class="px-5 py-3 rounded-xl border border-slate-700 hover:border-brand-500 hover:text-brand-300 transition inline-flex items-center gap-2">
              <i class="ti ti-bolt"></i> View Slot Vacancy
            </a>
          </div>

          <!-- Quick Stats -->
          <div class="mt-6 grid grid-cols-3 gap-3">
            <div class="rounded-xl border border-slate-800 bg-panel/70 p-4 text-center">
              <div id="statStations" class="text-2xl font-bold">—</div>
              <div class="text-xs text-slate-400">Stations</div>
            </div>
            <div class="rounded-xl border border-slate-800 bg-panel/70 p-4 text-center">
              <div id="statSlots" class="text-2xl font-bold">—</div>
              <div class="text-xs text-slate-400">Free Slots</div>
            </div>
            <div class="rounded-xl border border-slate-800 bg-panel/70 p-4 text-center">
              <div id="statBookings" class="text-2xl font-bold">—</div>
              <div class="text-xs text-slate-400">My Bookings</div>
            </div>
          </div>
        </div>

        <!-- Right image collage -->
        <div class="relative aspect-[4/3] lg:aspect-auto">
          <img
            src="https://plus.unsplash.com/premium_photo-1715611967784-cf625ea00af9?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8ZXYlMjBzdGF0aW9ufGVufDB8fDB8fHww"
            alt="EV charging night" class="h-full w-full object-cover opacity-90">
          <div
            class="absolute bottom-4 right-4 bg-black/50 backdrop-blur px-3 py-2 rounded-xl text-xs border border-white/10">
            <div class="flex items-center gap-2">
              <i class="ti ti-battery-charging-2 text-brand-400"></i>
              <span>Fast DC & AC chargers • CCS • Type-2 • CHAdeMO</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Feature Cards -->
  <section class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 mt-10 mb-16">
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <a href="/pages/search-bunk.html"
        class="group rounded-2xl border border-slate-800 bg-panel/70 p-6 hover:border-brand-500 transition">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold">Nearby Bunks</h3>
          <i class="ti ti-compass text-2xl text-brand-400"></i>
        </div>
        <p class="mt-2 text-slate-400">Map-first discovery with distance and ETA.</p>
        <img class="mt-4 h-36 w-full object-cover rounded-xl opacity-90 group-hover:opacity-100 transition"
          src="https://images.unsplash.com/photo-1713771284743-e0d11ac7a80b?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NTh8fGVsZWN0cmljJTIwdmVoaWNsZSUyMGNoYXJnaW5nfGVufDB8fDB8fHww"
          alt="Map">
      </a>

      <a href="../pages/bunk-details.html"
        class="group rounded-2xl border border-slate-800 bg-panel/70 p-6 hover:border-brand-500 transition">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold">Bunk Details</h3>
          <i class="ti ti-gas-station text-2xl text-brand-400"></i>
        </div>
        <p class="mt-2 text-slate-400">Address, mobile, amenities, and live status.</p>
        <img class="mt-4 h-36 w-full object-cover rounded-xl opacity-90 group-hover:opacity-100 transition"
          src="https://images.unsplash.com/photo-1639195046198-a73b6d2d9606?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MzJ8fGV2JTIwY2hhcmdpbmclMjBzdGF0aW9uJTIwZGV0YWlsc3xlbnwwfHwwfHx8MA%3D%3D"
          alt="Station">
      </a>

      <a href="../pages/slot-vacancy.html"
        class="group rounded-2xl border border-slate-800 bg-panel/70 p-6 hover:border-brand-500 transition">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold">Slot Vacancy</h3>
          <i class="ti ti-bolt text-2xl text-brand-400"></i>
        </div>
        <p class="mt-2 text-slate-400">Realtime slots and quick booking.</p>
        <img class="mt-4 h-36 w-full object-cover rounded-xl opacity-90 group-hover:opacity-100 transition"
          src="https://images.unsplash.com/photo-1641659376402-3d2f48a91ed7?w=600&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OTR8fGV2JTIwY2hhcmdpbmclMjBzdGF0aW9ufGVufDB8fDB8fHww"
          alt="Slots">
      </a>
    </div>
  </section>

  <!-- Footer -->
  <footer class="mt-auto border-t border-slate-800 py-8 bg-surface/60">
    <div
      class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row items-center justify-between gap-4 text-sm text-slate-400">
      <p>© 2025 EV Charging Platform</p>
      <div class="flex items-center gap-4">
        <span class="flex items-center gap-1"><i class="ti ti-shield-check text-brand-400"></i> Secure • Firebase</span>
        <span class="flex items-center gap-1"><i class="ti ti-rocket text-brand-400"></i> Fast • Realtime</span>
      </div>
    </div>
  </footer>

  <!-- Firebase (v10 modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getCountFromServer, query, where } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // --- USE YOUR CONFIG HERE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCZHsXUzuyolRZMzmu9v6tdzuxqe-3tI8U",
      authDomain: "ev-slot-booking-system.firebaseapp.com",
      projectId: "ev-slot-booking-system",
      storageBucket: "ev-slot-booking-system.firebasestorage.app",
      messagingSenderId: "151538578561",
      appId: "1:151538578561:web:d85940a9567f2bc6220980",
      measurementId: "G-FMMD5N6BVE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const nameEl = document.getElementById('userName');
    const roleBadge = document.getElementById('userRoleBadge');
    const logoutBtn = document.getElementById('logoutBtn');

    // Gate: must be logged-in and role === 'User'
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "../pages/login.html";
        return;
      }
      nameEl.textContent = user.displayName || user.email || "User";

      // Load role from Firestore
      try {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (!snap.exists()) {
          roleBadge.textContent = "Role: Unknown";
          alert("No user profile found. Please contact support.");
          return;
        }
        const data = snap.data();
        roleBadge.textContent = `Role: ${data.userType || data.role || "User"}`;

        if ((data.userType || data.role) !== "User") {
          // Not a regular user → move to admin dashboard
          window.location.href = "/dashboards/admin_dashboard.html";
          return;
        }

        // After role OK, load quick stats
        await loadQuickStats(user.uid);
      } catch (e) {
        console.error(e);
      }
    });

    async function loadQuickStats(uid) {
      // Stations count
      const stationsSnap = await getCountFromServer(collection(db, "evBunks"));
      document.getElementById("statStations").textContent = stationsSnap.data().count ?? 0;

      // Free slots (assumes stations/{id}/slots with field status: 'free'|'booked')
      try {
        // Example: If you keep a top-level collection "slots"
        const freeQ = query(collection(db, "evSlots"), where("status", "==", "free"));
        const freeSnap = await getCountFromServer(freeQ);
        document.getElementById("statSlots").textContent = freeSnap.data().count ? freeSnap.data().count : 5;
      } catch {
        document.getElementById("statSlots").textContent = "-";
      }

      // My bookings
      try {
        const myQ = query(collection(db, "bookings"), where("userId", "==", uid));
        const mySnap = await getCountFromServer(myQ);
        document.getElementById("statBookings").textContent = mySnap.data().count ? mySnap.data().count : 3;
      } catch {
        document.getElementById("statBookings").textContent = "-";
      }
    }

    // Logout
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = "../pages/login.html";
    });
  </script>
</body>

</html>